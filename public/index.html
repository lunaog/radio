<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset='utf-8'>
	<title>Radio</title>
	<meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'> 
	<script src="https://code.jquery.com/jquery-3.3.1.min.js">
	</script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'>
	</script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet'>
	<style>
	       body {
	       margin: 0;
	       padding: 0;
				 
	       }
	       
	       #container {
         position: absolute;
	       bottom: 40px;
         padding: 20px;
				 left: -25px;
         margin: 20px;
				 width: 55%;
         }

  
				#container-2 {
         position: absolute;
	       bottom: 250px;
         padding: 10px;
				 right: 0px;
         margin: 20px;
				 width: 35%;
         }

        #description {
          
          margin-right: 10px;
          margin-left: 10px;
          bottom: 0;
          width: 100%;
					text-align: justify;
					font-family: Arial;
					text-align: justify;
         }

				 h3 {
					text-align: justify;
					font: Arial;
					color: #C0BDA5;
					font-size: 30px;
				 }

					h4 {
					text-align: justify;
					font: Arial;
				width: 100%;
					font-size: 15px;
					font-style: normal;
					font-weight: normal;
				 }
 
				 h5 {
					right: 0px;
					position: absolute;
					text-align: justify;
					font-family: Arial;
					font-size: 15px;
					font-style: normal;
					font-weight: normal;
					 
				 }
				

         #map {
	       position: absolute;
	       top: 0;
	       bottom: 300px;
         width: 100%;
	       }

	       .usercoordinates {
	       background: rgba(0,0,0,0.5);
	       color: #fff;
	       position: absolute;
	       bottom: 10px;
	       left: 10px;
	       padding:5px 10px;
	       margin: 0;
	       font-size: 11px;
	       line-height: 18px;
	       border-radius: 3px;
	       display: none;
           }

           audio {
             display: block;
             margin: 10;
             width: 55%;
             height: 55px;
             border: solid;
             border-width: 15px;
            
             border-color: #DCDCDC;
             border-radius: 1px;
             background-color: #DCDCDC;
             position: absolute;
             bottom: 0px;

             filter: sepia(50%) saturate(400%) grayscale(0) contrast(1000%) hue-rotate(-66deg) invert(14%);
           }
          
           .mapboxgl-popup-close-button {
             display: none;
           }

           .mapboxgl-popup-content {
             padding: 5;
             width: 100%;  
            border-radius: 1px;
             align-content: center;
            }
            
            .mapboxgl-popup-content {
            color: blue;
            font: 12px/20px 'Open Sans', sans-serif;
            }

            .mapboxgl-popup-tip{
              display: none;
            }
       
	</style>
</head>
<body>
  <div id= "container">
  <div id= "description">
		
		<h3>
				La Red Radio
    </h3> 
    <h4>
				La Red Radio is based off the idea that sound is incubated collectively, so community is a vital aspect of the process of music distribution. In a world where we rely on machines to tell us what to listen to (and more increasingly, what to make), it is important that us subjects take control of our listening process.
		</h4>        
		</div>
	</div>
	<div id= "container-2">
		<h5> 
			La Red Radio is in constant engagement with diaspora as a theory and a direct manifestation of both 
			forced and chosen immigration due to things like colonialism, war, famine as well as love and hope.
			<br>
			<br>
			To add music, go to the landing site and drag the purple dot to the location from where the artist is from.	
			(Choose a location where the artist is based, where the artist's sound is incubated or where the artist claims roots.)
			<br><br>
			Once the dot is over a specific location (can be specific as a neighborhood or as general as a country), double click.
			<br><br>
			Fill out the form with a Youtube Video.
			<br><br>
			Go back to the main page. You should see your music added :) </h5> 
		</div>
    

    <p class="visually-hidden audio-transcript" tabindex="0">This is an audio recording. You are hearing the audio.</p>      
    <audio controls id="audioFile" type="audio/webm" autoplay="autoplay" controlsList="nodownload"></audio>
    
    </div></audio>
<div id="map"></div>          
	<pre id='mouseLatLong'></pre>
	<pre class='usercoordinates' id='usercoordinates'></pre>
	<script>
	   mapboxgl.accessToken = 'pk.eyJ1IjoibHVuYS1vZyIsImEiOiJjamY5b3o4ZzMyM3pxMn' +
	                          'dwZDg3b3ltNjFoIn0.38MEVY0yF9PIxTBqHuJV0Q';
	   var coordinates = document.getElementById('coordinates');
	   const map = new mapboxgl.Map({
	     container: 'map',
	     style: 'mapbox://styles/luna-og/cjsgw6rqx3sbq1fmma2l4k5e4',
			 zoom: "3",
	   });
	   
	   window.addEventListener('load',init);
	   function init(){  // on page load, get data and render
	     getData();
	   }
     var canvas = map.getCanvasContainer();
     
	   //User coordinates 
	   var geojson = {
	     "type": "FeatureCollection",
	     "features": [{
	       "type": "Feature",
	           "geometry": {
	             "type": "Point",
	             "coordinates": [0, 0]
	         },
	     }]
	   };
	   
	   function onMove(e) {
	     var coords = e.lngLat;
	     // Set a UI indicator for dragging.
	     canvas.style.cursor = 'grabbing';
	     // Update the Point feature in `geojson` coordinates
	     // and call setData to the source layer `point` on it.
	     geojson.features[0].geometry.coordinates = [coords.lng, coords.lat];
	     map.getSource('point').setData(geojson);
	   }

	   function onUp(e) {
	       var coords = e.lngLat;    
	       // Unbind mouse/touch events
	       map.off('mousemove', onMove);
	       map.off('touchmove', onMove);
	   }


	   var features =[];
	   function getData(){
	     $.ajax({
	         url: '/api/get',
	         type: 'GET',
	         failure: function(err){
	           console.log ("Could not get the data");
	           return alert("Something went wrong");
	       },
	       success: function(data) {
	         data.forEach(function(currentArtist){
	           //var str = currentArtist["city"];
	           //var coords = str.split(',');
	           var lat = parseFloat(currentArtist["lat"]);
	           var lon = parseFloat(currentArtist["lon"]);
	           var obj = {
	             "type": "Feature",
	             "geometry": {
	                   "type": "Point",
	                   "coordinates": [lon, lat]
	             },
	             "properties": {
	               "artist": currentArtist
	             }
	           }   
	           console.log([lat, lon]);
	           features.push(obj);
	         })
	         drawMap();
	         }
	     });
	   }

	   function drawMap(){
	     mapboxgl.accessToken = 'pk.eyJ1IjoibHVuYS1vZyIsImEiOiJjamY5b3o4ZzMy' +
	                            'M3pxMndwZDg3b3ltNjFoIn0.38MEVY0yF9PIxTBqHuJ' +
	                            'V0Q';
	     map.on('load', function() {
	     //map.loadImage("https://cdn0.iconfinder.com/data/icons/small-n-flat/" +
	     //              "24/678111-map-marker-512.png",
	       map.loadImage("marker2.png",
	       // this is where we load the image file
	       function(error, image) { 
	         // this is where we name the image file we are loading
	         map.addImage("custom-marker", image); 
	         map.addLayer({
	           // this is the name of the layer, it is what we will reference
	           // below
	           'id': "markers",
	           'type': "symbol",
	           // now we are adding the source to the layer more directly and
	           // cleanly
	           'source': { 
	             'type': "geojson",
	             'data': {
	               'type' : 'FeatureCollection',
	               'features' : features,
	              }
	           },
	           'layout': {
	               // the name of image file we used above
	              "icon-image": "custom-marker",
	              "icon-allow-overlap": false,
	               // this is a multiplier applied to the standard size. So if
	               // you want it half the size put ".5"
	              "icon-size": .04 
	           }
	         }) 
	       
	         //User-Coordinates
	         map.addSource('point', {
	           "type": "geojson",
	           "data": geojson
	         });

	         map.addLayer({
	          "id": "point",
	          "type": "circle",
	          "source": "point",
	          "paint": {
	              "circle-radius": 10,
	              "circle-color": "#4B0082"
	           }
	         });

	       
	         // When the cursor enters a feature in the point layer, prepare
	         // for dragging.
	         map.on('mouseenter', 'point', function() {
	           map.setPaintProperty('point', 'circle-color', '#800080');
	             canvas.style.cursor = '';
	         });

	         map.on('mouseleave', 'point', function() {
	           map.setPaintProperty('point', 'circle-color', '#4B0082');
	             canvas.style.cursor = '';
	         });

	         map.on('mousedown', 'point', function(e) {
	           // Prevent the default map drag behavior.
	           e.preventDefault();
	           canvas.style.cursor = 'grab';
	           map.on('mousemove', onMove);
	           map.once('mouseup', onUp);
	         });

	         // Other stuff 
	         map.on('click', 'markers', function(e) {
	           console.log(e);
	           console.log(e.features);
	           var coordinates = e.features[0].geometry.coordinates.slice();

	           // make this so that it grabs the audio from the coresponding
	           // json object and play it 
	           artist = JSON.parse(e.features[0].properties.artist);
             var description = artist["name"];  

             

            // grab source element with id "audioFile"
            // set attribute "src" to file
            var elt = document.getElementById("audioFile");
            elt.src = artist["filename"];
            console.log(elt);
	           
	           while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
	             coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
	           }

	           new mapboxgl.Popup()
	             .setLngLat(coordinates)
	             .setHTML(description)
	             .addTo(map);          
	         })
	       });

	       // Change the cursor to a pointer when the mouse is over the places
	       // layer.
	       map.on('mouseenter', 'markers', function () {
	       map.getCanvas().style.cursor = 'pointer';
	        });

	       // Change it back to a pointer when it leaves.
	       map.on('mouseleave', 'markers', function () {
	         map.getCanvas().style.cursor = '';
	       });

	       map.on('dblclick', 'point', function (e) {
	         e.preventDefault();

	         var lat = e.lngLat.lat;
	         var lon = e.lngLat.lng;
	         var params = $.param({
	           lat: lat,
	           lon: lon
	         });
	         var url = "http://178.128.158.17:3000/form.html/?" + params; //digital ocean server
	         window.location.href = url;

	       });
	     });
       console.log(features);
      }  
	     
	</script> 
</body>
</html>